

### 推导 $E[ |a^H w|^2 ]$ 的计算过程和结果

您好！基于对话背景，我理解您对相位误差（phase error）如何影响期望值 $E[ |a^H w|$^2 ]（其中 a 是阵列响应矢量，w 是预编码向量）仍有疑问。这是一个关键的二阶矩（second moment），它直接关系到波束赋形增益（beamforming gain）和谱效率（SE）中的有效信号强度。例如，在 SE 计算中，信号项往往正比于 |a^H w|^2（或其期望），相位误差会通过破坏相干性（coherence）来降低这个值，从而使 SE 曲线偏移。

下面，我分别针对**不带误差**（理想情况）和**带相位误差**（误差为 i.i.d. 高斯随机变量 x_k ~ N(0, σ²)）两种情况，逐步推导 $E[ |a^H w|^2 ]$。假设：
- $a ∈ ℂ^{N×1}$ 是理想阵列响应矢量（array response vector, ARV），其元素$ a_k = e^{j φ_k}$（单位模，|a_k| = 1，例如均匀线性阵列 ULA 中的相位项，$φ_k = 2π (k-1) d sinθ / λ$）。
- $||a||² = ∑_k |a_k|² = N$（功率归一化到 N，常用于突出阵列增益）。
- $w ∈ ℂ^{N×1} $是确定性预编码向量（例如基于理想 a 的 MRT 预编码：$w = a / √N$，这样 $||w||² = 1$，确保总发射功率归一化）。
- 带误差的向量记为 $ \tilde{a}，\tilde{a}_k = a_k e^{j x_k}$（$|\tilde{a}_k| = 1$ 仍成立）。
- 期望 E[·] 是相对于随机误差 x_k 取的（如果无误差，则 E[·] 退化为本身）。

推导使用线性代数和概率论（独立性、特征函数），确保步骤透明。如果您的归一化或 w 定义不同（如 ||a||² = 1），逻辑类似，只需调整尺度。

---

#### 1. 不带误差的情况（理想情况）
- **模型**：a 是确定性的（无随机 x_k），所以 $\tilde{a} = a$。
- **目标**：$E[ |a^H w|^2 ] = |a^H w|^2$（因为无随机性，期望就是值本身）。

**推导过程**：
1. 内积 $a^H w = ∑_{k=1}^N a_k^* w_k$（其中 * 表示共轭）。
2. 模平方 $|a^H w|^2 = (a^H w) (a^H w)^* = (∑_k a_k^* w_k) (∑_m a_m w_m^*)（注：(a^H w)^* = w^H a）$。
3. 展开双和：$|a^H w|^2 = ∑_k ∑_m a_k^* a_m w_k w_m^*$。
   - 这可以分为对角项（k=m）和非对角项（k≠m）：
     - 对角：$∑_k |a_k|² |w_k|²$（因为 $a_k^* a_k = |a_k|² = 1$）。
     - 非对角：$∑_{k≠m} a_k^* a_m w_k w_m^*$。
4. 由于无随机性，无需取期望：$E[ |a^H w|^2 ] = |a^H w|^2 = ∑_k |w_k|² + ∑_{k≠m} a_k^* a_m w_k w_m^*$（因为 $|a_k|²=1，∑_k |w_k|²$ 部分来自对角）。

**结果**（一般形式）：
- $E[ |a^H w|^2 ] = ∑_{k,m} a_k^* a_m w_k w_m^* = (a^H w) (w^H a) = |a^H w|^2$。

**特殊案例（假设 MRT 预编码 w = a / √N）**：
- $a^H w = a^H (a / √N) = ||a||² / √N = N / √N = √N$。
- $|a^H w|^2 = N$（理想相干增益：所有天线同相叠加，增益正比于 N）。
- $E[ |a^H w|^2 ] = N$。
- **影响理解**：无误差时，期望值达到最大（N），因为相位完美对齐，所有项相干贡献。

---

#### 2. 带相位误差的情况
- **模型**：$\tilde{a}_k = a_k e^{j x_k}，x_k ~ N(0, σ²) i.i.d.$（独立同分布高斯，零均值，方差 σ²）。
- **目标**：$E[ |\tilde{a}^H w|^2 ]$（期望相对于所有 x_k 取）。

**推导过程**：
1. 内积 $\tilde{a}^H w = ∑_{k=1}^N \tilde{a}_k^* w_k = ∑_k a_k^* e^{-j x_k} w_k$（因为 $\tilde{a}_k^* = a_k^* e^{-j x_k}$）。
2. 模平方 $|\tilde{a}^H w|^2 = (∑_k a_k^* e^{-j x_k} w_k) (∑_m a_m e^{j x_m} w_m^*)$。
3. 展开双和：$|\tilde{a}^H w|^2 = ∑_k ∑_m a_k^* a_m w_k w_m^* e^{-j x_k} e^{j x_m} = ∑_k ∑_m a_k^* a_m w_k w_m^* e^{j (x_m - x_k)}$。
   - 这仍是确定性部分 ($a_k^* a_m w_k w_m^*$) 乘以随机部分 e^{j (x_m - x_k)}。
4. 现在取期望 $E[ |\tilde{a}^H w|^2 ] = ∑_k ∑_m a_k^* a_m w_k w_m^* E[ e^{j (x_m - x_k)} ]$（因为期望线性，且确定性可移出）。
   - 由于 x_k, x_m i.i.d.，$E[ e^{j (x_m - x_k)} ] = E[ e^{j x_m} ] E[ e^{-j x_k} ]$（独立性）。
   - 对于高斯 x ~ N(0, σ²)，特征函数 $E[ e^{j t x} ] = e^{- (1/2) σ² t²}$。
     - 因此，$E[ e^{j x_m} ] = e^{- (1/2) σ² (1)^2} = e^{-σ²/2}$。
     - $E[ e^{-j x_k} ] = e^{- (1/2) σ² (-1)^2} = e^{-σ²/2}$（复共轭不影响，因为实值）。
     - 所以，对于 $k ≠ m：E[ e^{j (x_m - x_k)} ] = e^{-σ²/2} ⋅ e^{-σ²/2} = e^{-σ²}$。
     - 对于$ k = m：x_m - x_k = 0，E[ e^{j 0} ] = 1$（无随机性）。
5. 分离对角和非对角项：
   - 对角项（k=m）：$∑_k a_k^* a_k w_k w_k^* E[1] = ∑_k |a_k|² |w_k|² = ∑_k |w_k|²$（因为 |a_k|²=1）。
   - 非对角项（k≠m）：$∑_{k≠m} a_k^* a_m w_k w_m^* e^{-σ²} = e^{-σ²} ⋅ (∑_{k,m} a_k^* a_m w_k w_m^* - ∑_k |a_k|² |w_k|²) = e^{-σ²} ⋅ (|a^H w|^2 - ∑_k |w_k|²)$。
6. 组合：$E[ |\tilde{a}^H w|^2 ] = ∑_k |w_k|² + e^{-σ²} ⋅ (|a^H w|^2 - ∑_k |w_k|²)$。

**结果**（一般形式）：
- $E[ |\tilde{a}^H w|^2 ] = (1 - e^{-σ²}) ∑_k |w_k|² + e^{-σ²} |a^H w|^2$。
- 这是一个加权平均：当 σ²=0（无误差），退化为 |a^H w|^2；当 σ²→∞（极大误差），退化为 ∑_k |w_k|²（非相干增益，仅功率相加，无相干叠加）。

**特殊案例（假设 MRT 预编码 w = a / √N）**：
- $||w||² = 1，所以 ∑_k |w_k|² = 1（因为 |w_k|² = |a_k|² / N = 1/N，∑_k 1/N = 1$）。
- $|a^H w|^2 = |a^H (a / √N)|^2 = | ||a||² / √N |² = (N / √N)² = N$（理想增益）。
- 因此$，E[ |\tilde{a}^H w|^2 ] = (1 - e^{-σ²}) ⋅ 1 + e^{-σ²} ⋅ N = 1 + (N - 1) e^{-σ²}$。
- **数值示例**：
  - σ²=0：E = 1 + (N-1)⋅1 = N（最大相干增益）。
  - σ²小（如0.1）：e^{-0.1}≈0.905，E ≈ 1 + (N-1)⋅0.905 ≈ 0.905 N + 0.095（轻微下降）。
  - σ²大（如10）：e^{-10}≈4.5e-5，E ≈1（退化为非相干，仅1，而非N）。

---

#### 相位误差对期望值的影响理解
- **为什么有影响？** 无误差时，$E[ |a^H w|^2 ] = N$（MRT下），所有天线相位对齐，信号同相叠加（相干增益 ∝ N）。带误差后，相位随机扰动（x_k），破坏对齐：对角项（∑ |w_k|²=1）代表“非相干”功率相加（仅 ∝1）；非对角项（相干部分）被 e^{-σ²} 衰减（因为 $E[e^{j(x_m - x_k)}] = e^{-σ²}$，反映相位差的随机性）。结果：期望从 N 降到 1 + (N-1) e^{-σ²}，损失 (N-1)(1 - e^{-σ²})。
- **在 SE 中的体现**：$SE ∝ log(1 + SNR ⋅ E[ |a^H w|^2 ] / N)$ 或类似（归一化后）。误差使有效增益下降，导致 SE 降低，尤其高 SNR 时（增益主导）。如果 σ² 小，影响小（曲线轻微偏移）；σ² 大，SE 接近无阵列增益的情况。
- **为什么之前觉得“隐形”？** 因为模平方$ |\tilde{a}_k|²=1$ 不变，总功率 $||\tilde{a}||²=N$ 不变。但期望通过内积捕捉相干损失——如果只看功率（不看内积），误差隐形；但 SE 依赖内积，所以必须考虑。

如果需要代码模拟（e.g., Python 蒙特卡洛验证）、更一般误差分布（如均匀），或调整假设（如 ||a||²=1），请告诉我！